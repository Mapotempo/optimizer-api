version: '3.3'

services:
  api:
    image: mapotempo/optimizer-api:latest
    environment:
      APP_ENV: test
      REDIS_HOST: redis-cache
      REDIS_RESQUE_HOST: redis
      SKIP_JSPRIT: 'true'
    networks:
      - redis_cache
      - resque

  resque-default:
    image: mapotempo/optimizer-api:latest
    working_dir: /srv/app
    command: bundle exec rake resque:workers
    hostname: resque-default
    environment:
      ROUTER_API_KEY: ${ROUTER_API_KEY}
      ROUTER_URL: ${ROUTER_URL}
      REDIS_RESQUE_HOST: redis
      REDIS_HOST: redis-cache
      COUNT: 5
      QUEUES: DEFAULT
      APP_ENV: test
    networks:
      - redis_cache
      - resque

  redis:
    image: redis:${REDIS_VERSION:-3.2-alpine}
    volumes:
      - ./redis:/data
    command: redis-server --appendonly yes
    networks:
      - resque

  redis-cache:
    image: redis:${REDIS_VERSION:-3.2-alpine}
    volumes:
      - ./redis:/data
    command: redis-server --save ""
    networks:
      - redis_cache

networks:
  resque:
  redis_cache:
